function initGraph(){simulation=d3.forceSimulation(nodes).force("link",d3.forceLink(links).id((e=>e.id)).distance(30)).force("charge",d3.forceManyBody().strength(-30)).force("center",d3.forceCenter(svgWidth/2,svgHeight/2)).force("x",d3.forceX(svgWidth/2).strength(.2)).force("y",d3.forceY(svgHeight/2).strength(.35)).force("collide",d3.forceCollide().radius(3));const e=graphSvg.append("g").selectAll("line").data(links).enter().append("line").attr("class","link"),t=graphSvg.selectAll(".node-group").data(nodes).enter().append("g").attr("class","node-group").on("mouseenter",((e,t)=>{highlightNode(t.id),showTooltip(e,t)})).on("mouseleave",(()=>{clearHighlight(),hideTooltip()})).on("click",((e,t)=>toggleSelection(t.id))).call(d3.drag().on("start",dragstarted).on("drag",dragged).on("end",dragended));t.append("circle").attr("class","node").attr("r",nodeRadius),simulation.on("tick",(()=>{e.attr("x1",(e=>e.source.x)).attr("y1",(e=>e.source.y)).attr("x2",(e=>e.target.x)).attr("y2",(e=>e.target.y)),t.attr("transform",(e=>`translate(${e.x},${e.y})`))}))}function dragstarted(e,t){e.active||simulation.alphaTarget(.3).restart(),t.fx=t.x,t.fy=t.y}function dragged(e,t){t.fx=e.x,t.fy=e.y}function dragended(e,t){e.active||simulation.alphaTarget(0),t.fx=null,t.fy=null}function highlightNode(e){graphSvg.selectAll("g.node-group").select("circle.node").classed("highlight",(t=>t.id===e)),graphSvg.selectAll("line.link").classed("highlight",(t=>t.source.id===e||t.target.id===e)),graphSvg.selectAll("text.node-label").classed("highlight",(t=>t.id===e))}function highlightEdge(e,t){graphSvg.selectAll("text.node-label").classed("highlight",(n=>n.id===e||n.id===t)),graphSvg.selectAll("line.link").classed("highlight",(n=>n.source.id===e&&n.target.id===t||n.source.id===t&&n.target.id===e))}function clearHighlight(){d3.selectAll(".highlight").classed("highlight",!1)}function toggleSelection(e){graphSvg.selectAll("circle.node").filter((t=>t.id===e)).classed("selected",(function(){return!d3.select(this).classed("selected")}))}function showTooltip(e,t){const n=d3.select("#centralityDropdown").property("value"),a=graph_centrality[t.id];if(console.log(a),!a)return;let l=a[n];"degree_centrality"!==n&&(l=l?.toFixed(3)),tooltip.style("display","block").html(`\n      <b>ID:</b> ${t.id}<br>\n      <b>${n.replace(/_/g," ")}:</b> ${l}<br>\n    `).style("left",e.pageX+10+"px").style("top",e.pageY+10+"px")}function hideTooltip(){tooltip.style("display","none")}function updateHighlight(){const e=dropdown.property("value"),t=+topNInput.property("value"),n=nodes.map((t=>({id:t.id,value:graph_centrality[t.id][e]}))).sort(((e,t)=>t.value-e.value)).slice(0,t).map((e=>e.id));graphSvg.selectAll("circle.node").classed("selected",!1),graphSvg.selectAll("circle.node").filter((e=>n.includes(e.id))).classed("selected",!0)}function updatePercolation(e){currentTimestep=e;const t=infectionData[e];t&&graphSvg.selectAll("circle.node").each((function(e){const n=t[e.id];d3.select(this).classed("infected",1===n?.infected).classed("risky",1===n?.risky).classed("normal",!(1===n?.infected||1===n?.risky))}))}function playAnimation(){isPlaying||(isPlaying=!0,animationInterval=setInterval((()=>{currentTimestep++,currentTimestep>=maxTimestep&&(currentTimestep=0,clearInterval(animationInterval),isPlaying=!1),updatePercolation(currentTimestep)}),1e3))}function stopAnimation(){clearInterval(animationInterval),isPlaying=!1}function updateVoterankStep(e){voterankCurrentStep=e;const t=voterankHistory[e];t&&graphSvg.selectAll("circle.node").each((function(e){const n=t[e.id];d3.select(this).classed("people",!1).classed("influencer",!1).classed("crowd",!1),n&&"people"!==n.type?"influencer"===n.type?d3.select(this).classed("influencer",!0):"crowd"===n.type&&d3.select(this).classed("crowd",!0):d3.select(this).classed("people",!0)}))}function stopVoterankAnimation(){clearInterval(voterankAnimation),voterankAnimation=null}const svgSize=720,svgWidth=750,svgHeight=480,nodesCount=890,graphSvg=d3.select("#graph"),nodeRadius=5,edgeLen=10;let playInterval,maxTimestep=0,currentTimestep=0,animationInterval=null,isPlaying=!1,voterankCurrentStep=0,voterankAnimation=null,maxVoterankTimestep=0;const centralityMeasures=[{key:"degree_centrality",label:"Degree Centrality"},{key:"closeness_centrality",label:"Closeness Centrality"},{key:"betweenness_centrality",label:"Betweenness Centrality"},{key:"current_flow_closeness",label:"Current Flow Closeness"},{key:"current_flow_betweenness",label:"Current Flow Betweenness"},{key:"eigenvector_centrality",label:"Eigenvector Centrality"},{key:"load_centrality",label:"Load Centrality"},{key:"subgraph_centrality",label:"Subgraph Centrality"},{key:"harmonic_centrality",label:"Harmonic Centrality"},{key:"communicability_betweenness",label:"Communicability Betweenness"},{key:"laplacian_centrality",label:"Laplacian Centrality"}];["#graph"].forEach((e=>{d3.select(e).attr("width",svgWidth).attr("height",svgHeight).style("border","1px solid black")}));let simulation,nodes=[],links=[],graph_centrality={},infectionData={},voterankHistory=[];Promise.all([d3.csv("https://raw.githubusercontent.com/7vidhan/NetworkAnalysis/main/webpage/asset/nodes.csv"),d3.csv("https://raw.githubusercontent.com/7vidhan/NetworkAnalysis/main/webpage/asset/edges.csv"),d3.csv("https://raw.githubusercontent.com/7vidhan/NetworkAnalysis/main/webpage/asset/graph_centralities.csv"),d3.csv("https://raw.githubusercontent.com/7vidhan/NetworkAnalysis/main/webpage/asset/infection_history.csv"),d3.csv("https://raw.githubusercontent.com/7vidhan/NetworkAnalysis/main/webpage/asset/voting_history.csv")]).then((([e,t,n,a,l])=>{n.forEach((e=>{graph_centrality[e.ID]={degree_centrality:parseInt(Math.round(+e.degree_centrality*(nodesCount-1)),10),closeness_centrality:+e.closeness_centrality,betweenness_centrality:+e.betweenness_centrality,current_flow_closeness:+e.current_flow_closeness,current_flow_betweenness:+e.current_flow_betweenness,eigenvector_centrality:+e.eigenvector_centrality,load_centrality:+e.load_centrality,subgraph_centrality:+e.subgraph_centrality,harmonic_centrality:+e.harmonic_centrality,communicability_betweenness:+e.communicability_betweenness,laplacian_centrality:+e.laplacian_centrality}})),nodes=e.map((e=>({id:e.ID,centrality:graph_centrality[e.ID]||{}}))),links=t.map((e=>({source:e.member1,target:e.member2}))),a.forEach((e=>{const t=+e.timestep;infectionData[t]||(infectionData[t]={}),infectionData[t][e.node]={infected:+e.infected,risky:+e.risky},t>maxTimestep&&(maxTimestep=t)})),l.forEach((e=>{const t=+e.timestep;voterankHistory[t]||(voterankHistory[t]={}),voterankHistory[t][e.node]={type:e.type},t>maxVoterankTimestep&&(maxVoterankTimestep=t)})),initGraph()}));const tooltip=d3.select("body").append("div").attr("id","tooltip").style("position","absolute").style("background","#efe0b4ff").style("border","1px solid #efe0b4ff").style("padding","6px").style("border-radius","4px").style("font-size","12px").style("display","none").style("pointer-events","none"),dropdown=d3.select("#centralityDropdown");dropdown.selectAll("option").data(centralityMeasures).enter().append("option").attr("value",(e=>e)).attr("value",(e=>e.key)).text((e=>e.label)),d3.select("#highlightBtn").on("click",(()=>{const e=dropdown.node().value,t=+document.getElementById("topN").value,n=nodes.map((t=>({...t,value:graph_centrality[t.id][e]}))).sort(((e,t)=>t.value-e.value)).slice(0,t),a=new Set(n.map((e=>e.id)));graphSvg.selectAll("circle.node").classed("selected",(e=>a.has(e.id)))})),d3.select("#clearBtn").on("click",(()=>{graphSvg.selectAll("circle.node").classed("selected",!1).classed("infected",!1).classed("risky",!1).classed("normal",!1).classed("people",!1).classed("influencer",!1).classed("crowd",!1),stopAnimation(),currentTimestep=0})),d3.select("#prevStepBtn").on("click",(()=>{currentTimestep>0&&updatePercolation(currentTimestep-1)})),d3.select("#nextStepBtn").on("click",(()=>{currentTimestep<maxTimestep&&updatePercolation(currentTimestep+1)})),d3.select("#playBtn").on("click",playAnimation),d3.select("#resetBtn").on("click",(()=>{stopAnimation(),currentTimestep=0,updatePercolation(currentTimestep)})),d3.select("#voterankResetBtn").on("click",(()=>{voterankCurrentStep=0,stopVoterankAnimation(),updateVoterankStep(voterankCurrentStep)})),d3.select("#voterankPrevStepBtn").on("click",(()=>{voterankCurrentStep>0&&voterankCurrentStep--,updateVoterankStep(voterankCurrentStep)})),d3.select("#voterankNextStepBtn").on("click",(()=>{voterankCurrentStep<voterankHistory.length-1&&voterankCurrentStep++,updateVoterankStep(voterankCurrentStep)})),d3.select("#voterankPlayBtn").on("click",(()=>{voterankAnimation||(voterankAnimation=setInterval((()=>{voterankCurrentStep>=voterankHistory.length-1?stopVoterankAnimation():(voterankCurrentStep++,updateVoterankStep(voterankCurrentStep))}),1e3))}));